# messer
Post-assembly small plasmid recovery and size correction workflow for nanopore sequence data

## Background and before you run
There are two issues when it comes to assembling small plasmids using long-read sequencing. First is recovery - long-read assemblers will often fail to capture or include small plasmids in the final assembly. Second is contig size - if captured, the size of the plasmid contig is often unexpectedly large. This workflow aims to alleviate that issue without having to resequence or supplement the long-read assembly with short-read data.

This workflow should work with just about any ONT assembly, but it was created specifically as a follow-up to [stylo](https://github.com/ncezid-narst/stylo). Stylo uses Nanoq and Rasusa to filter based on read length and randomly downsample respectively, which helps to ensure that shorter reads make it through to the assembly stage. Other read filtering/downsampling programs tend to prioritize longer reads, making it more likely that reads covering smaller plasmids (<10kb) aren't captured in the final assembly.

### **How does this work?**  
First, check your assembly and reads and confirm:
* Are all plasmid contigs present
* Are they all of expected size

For example, this final assembly generated by stylo has 5 contigs:
```bash
#seq_name       length  cov.    circ.   repeat  mult.   alt_group       graph_path
contig_1        4684667 117     Y       N       1       *       1
contig_3        86473   104     Y       N       1       *       3
contig_6        65862   60      Y       N       1       *       6
contig_5        6225    265     Y       N       11      *       5
contig_2        4440    954     Y       Y       9       *       2
```
Running staramr (plasmidfinder) on the assembly and reads reveals that the assembly is missing the plasmid replicon Col8282:
```bash
Assembly:
Isolate ID      Plasmid %Identity       %Overlap        HSP Length/Total Length Contig  Start   End     Accession
consensus       Col(pHAD28)     97.48   90.84   119/131 contig_2        3483    3601    KU674895
consensus       ColpVC  98.96   100.00  193/193 contig_5        638     446     JX133088
consensus       ColpVC  98.96   100.00  193/193 contig_5        2735    2543    JX133088
consensus       ColpVC  98.96   100.00  193/193 contig_5        4768    4576    JX133088
consensus       IncI1-I(Alpha)  100.00  100.00  142/142 contig_3        80086   79945   AP005147
consensus       IncX1   97.87   100.27  375/374 contig_6        15151   14777   EU370913
consensus       IncX1   97.87   100.27  375/374 contig_6        48086   47712   EU370913
```
```bash
Reads:
...
reads   IncI1-I(Alpha)  100.00  100.00  142/142 63e0b639-6567-4e3c-b088-5582d0d2efdb    9708    9567    AP005147
reads   IncX1   90.19   100.80  377/374 2da494a6-ea59-4c45-96d7-3f412db33750    9226    9596    EU370913
reads   Col(pHAD28)     95.80   90.84   119/131 6cba657d-dd00-49dd-a9e5-120d41643c34    844     960     KU674895
reads   Col8282 98.55   100.00  207/207 35c129e9-4f77-4e73-be7e-147c5174292d    1169    966     DQ995352
reads   Col8282 98.08   100.48  208/207 3a372196-67b9-4a44-8ee4-8acb7ac7e2ea    1173    968     DQ995352
reads   Col8282 98.07   100.00  207/207 9141ba62-77f7-4149-95f0-bed931b3670f    1173    969     DQ995352
reads   IncX1   93.33   100.27  375/374 4e8a53a4-7443-4d0d-81b4-bda0bc5a6e88    1337    969     EU370913
reads   ColpVC  97.93   100.00  193/193 cdeedecd-39b9-472c-83a4-7c8208c2093b    777     969     JX133088
...
```
Furthermore, according to reference sequences available on NCBI, contig_5 is the wrong size, at 6kb it is roughly 3x what it should be.

To sum up, Col8282 is missing from the final assembly and the contig ColpVC is on is the wrong size.

Next, check intermediate assemblies to see if any potential plasmid contigs were filtered out during the assembly process. In this case, the prepolish flye assembly under 30-contigger seems to have an extra contig:
```bash
flye/30-contigger/contigs_stats.txt:
#seq_name       length  coverage        circular        repeat  mult    telomere        alt_group       graph_path
contig_1        4681534 103     Y       N       1       none    *       1
contig_3        86243   88      Y       N       1       none    *       3
contig_4        16330   110     Y       N       1       none    *       4
contig_5        6265    23      Y       N       1       none    *       5
contig_6        65820   92      Y       N       1       none    *       6
contig_2        4436    730     Y       Y       7       none    *       2
```
Staramr confirms Col8282 is present on contig_4:
```bash
Isolate ID      Plasmid %Identity       %Overlap        HSP Length/Total Length Contig  Start   End     Accession
contigs Col(pHAD28)     93.89   100.00  131/131 contig_2        3235    3106    KU674895
contigs Col8282 100.00  100.00  207/207 contig_4        1744    1538    DQ995352
contigs Col8282 100.00  100.00  207/207 contig_4        5831    5625    DQ995352
contigs Col8282 100.00  100.00  207/207 contig_4        9914    9708    DQ995352
contigs Col8282 100.00  100.00  207/207 contig_4        13992   13786   DQ995352
contigs ColpVC  98.96   100.00  193/193 contig_5        634     826     JX133088
contigs ColpVC  98.96   100.00  193/193 contig_5        2717    2909    JX133088
contigs ColpVC  98.96   100.00  193/193 contig_5        4812    5004    JX133088
contigs IncI1-I(Alpha)  100.00  100.00  142/142 contig_3        36769   36628   AP005147
contigs IncX1   97.33   100.00  374/374 contig_6        14777   14404   EU370913
contigs IncX1   97.86   100.00  374/374 contig_6        47691   47319   EU370913
```
According to reference sequences, however, contig_4 appears to be 4x the expected size.

Now we're ready to recover and fix these plasmid contigs. We know:
* Which plasmid replicons are on which contigs
* The expected sizes of each plasmid
* Which draft assembly has the plasmid contigs we want to correct

## Install
Navigate to your home directory and git clone the repository.
```bash
$ git clone https://github.com/ncezid-narst/messer.git
```
You will need to install Nextflow if you don't already have it: https://www.nextflow.io/docs/latest/getstarted.html

You will also need to install Singularity if you don't already have it: https://docs.sylabs.io/guides/3.0/user-guide/quick_start.html

If you're working on CDC servers, run `module load nextflow/XX.XX.X` to load Nextflow, Singularity, and Java modules.

As of 6/16/2023, this workflow was developed on Nextflow version 22.10.6.

## Overview
* EXTRACT - Isolates target plasmid contigs using Seqtk
* ALIGN - Aligns raw reads to target plasmid contigs using Minimap2
* READSGET - Outputs successfully aligned reads to fastq format using Samtools
* READFILTERING - Filters aligned reads based on user-set minimum and maximum read lengths using Nanoq
* DOWNSAMPLE - Randomly downsamples read set based on target plasmid contig sizes and desired coverage using Rasusa
* ASSEMBLE - Generates target plasmid contigs using Flye

## Parameters
Parameters for each process can be changed in `messer.config` under the first bracketed section `params`. Check out [Resources](#resources) for links to each process's main github page to learn more about process-specific parameters.

Prior to running messer, make sure the INITIAL PARAMETERS are set accurately - the default settings are as follows:
```java
	//Initial parameters
	assembly = ''
	contiginfo = ''
	reads = ''
	outdir = 'messer'
```
`assembly`: Filepath (relative or absolute) to the draft flye assembly containing your target plasmid contigs.

`contiginfo`: Tab-delimited text file with contig information. For example:
```bash
WGSID   CONTIG  SIZE    REPLICON
PNUSAS002131    contig_4        4218    Col8282
PNUSAS002131    contig_5        2096    ColpVC
```
WGSID: Sample ID  
CONTIG: Name of contig in draft Flye assembly containing target plasmid replicon  
SIZE: Predicted size of plasmid contig either based on reference sequence or SME knowledge  
REPLICON: Name of plasmid replicon  

`reads`: Filepath (relative or absolute) to raw ONT reads (not filtered or downsampled)
`outdir`: Name of messer output directory. Default is set to `messer`.

## Processes
Directives for each process can be changed in `messer.config` under the second bracketed section `process`. This is where you can update the containers used in each process. Check out [Resources](#resources) to see a full list of all the containers and the tools' githubs.

## Profiles
Configuration settings for each profile can be changed in `messer.config` under the third bracketed section `profiles`. This is where you can update or create profiles that will dictate where and how each process is run. By default, there are two main profiles and three auxiliary profiles:

* `standard`: Will execute messer using the 'local' executor, running processes on the computer where Nextflow is launched. 
* `sge`: Will execute messer using a Sun Grid Engine cluster, running processes on the HPC (qsub).
* `short`: Auxiliary profile to change the sge default queue to short queue
* `gpu`: Auxiliary profile to chage the sge default queue to gpu queue
* `highmem`: Auxiliary profile to change the sge default queue to highmem queue

You can see how profiles are used in the next section **Usage**.

NOTE: The default profile settings were mostly pulled from recommendations made by CDC Scicomp in their Nextflow training called 'Reproducible, scalable, and shareable analysis workflows with Nextflow'. There is a good chance you will have to create/modify your own profile to run messer using your institution's computing environment. Check out [Resources](#resources) to learn more about creating profiles.

## Usage
Once you've made the necessary changes to the configuration file to run the workflow on your computing environment and have set up inital parameters, you can run messer just as you would any nextflow workflow:
```bash
nextflow run /path/to/messer/schtappe/messer.nf -c /path/to/messer/config/messer.config
```
Nextflow is picky about single-hyphen flags vs. double-hyphen flags. Single-hyphens affect the nextflow command while double-hyphens affect the parameters in the configuration file. For example, to change the initial parameters without directly editing `messer.config`:
```bash
nextflow run /path/to/messer/schtappe/messer.nf -c /path/to/messer/config/messer.config \
  --assembly path/to/your/assembly/flye/assembly.fasta \
  --contiginfo yourcontiginfo.txt \
  --reads path/to/your/raw/reads \
  --outdir youroutputdirectory \
```

By default, nextflow will run locally. If you want to specify a profile, use the `-profile` flag. For example, to qsub messer's processes:
```bash
nextflow run /.../messer/schtappe/messer.nf -c /.../messer/config/messer.config -profile sge
```

You can change the queue by adding the auxiliary profile name, separated by a comma:
```bash
nextflow run /.../messer/schtappe/messer.nf -c /.../messer/config/messer.config -profile sge,highmem
```
Run `nextflow help` or `nextflow run -help` for more information on nextflow flags.

## Output
Here's what messer's output looks like (directories only):
```bash
messer
└── PNUSAS002131
    ├── Col8282
    │   ├── flye
    │   │   ├── 00-assembly
    │   │   ├── 10-consensus
    │   │   ├── 20-repeat
    │   │   ├── 30-contigger
    │   │   └── 40-polishing
    │   └── reads
    └── ColpVC
        ├── flye
        │   ├── 00-assembly
        │   ├── 10-consensus
        │   ├── 20-repeat
        │   ├── 30-contigger
        │   └── 40-polishing
        └── reads
```
## Troubleshooting
1. **Plasmid contig is still the wrong size**  
This can occur due to a number of upstream factors. In our example, Col8282's plasmid contig comes out the wrong size:
```bash
messer/PNUSAS002131/Col8282/flye/assembly_info.txt:
#seq_name       length  cov.    circ.   repeat  mult.   alt_group       graph_path
contig_1        8181    39      Y       N       1       *       1
```
8kb is better than 16kb, but it's still not the expected contig size. In this case there are several potential fixes to try:
* Rerun messer on a new draft assembly:
    * Because rasusa is a random downsampler, it is possible to get unlucky and have under-representation of certain areas of the genome
* Rerun messer on the same draft assembly:
    * Same reason as above. Rerunning may yield a better set of downsampled reads and thus a better assembly.
*  Run messer using the messer-generated plasmid contig as the draft assembly:
    * Running the workflow again inside the workflow can iteratively improve the assembly

The third option in this case happens to correct the issue for Col8282:
```bash
#seq_name       length  cov.    circ.   repeat  mult.   alt_group       graph_path
contig_1        4090    113     Y       Y       4       *       1
```

2. **The assembly process failed**  
This can occur because of bad luck as mentioned before, or because flye's run parameters need to be adjusted. By default, the value for flye's `--min-overlap` flag is calculated automatically based on average read length. If you have an abundance of long reads, this could set the value much too high, preventing the assembly of smaller contigs. Try setting the parameter `flye_minoverlap` in `messer.config` to a value lower than the expected size of the plasmid contig i.e. 2000 or 1000 for an expected size of ~2kb.

Additionally, it might be worth narrowing the window of acceptable read lengths filtered by nanoq. Setting `nanoq_max_length` in `messer.config` to just above the expected size of the plasmid contig could help discourage flye from being overzealous in finding the overlaps that multiply the contig size. This could have a negative effect on coverage though, so tread with caution.

## Resources
### Containers:
* Nanoq:
  * https://hub.docker.com/r/jimmyliu1326/nanoq
  * https://github.com/esteinig/nanoq
* Rasusa: 
  * https://hub.docker.com/r/staphb/rasusa
  * https://github.com/mbhall88/rasusa
* Flye: 
  * https://hub.docker.com/r/staphb/flye
  * https://github.com/fenderglass/Flye
* Seqtk: 
  * https://hub.docker.com/r/staphb/seqtk
  * https://github.com/lh3/seqtk
* Minimap2:
  * https://hub.docker.com/r/staphb/minimap2
  * https://github.com/lh3/minimap2
* Samtools:
  * https://hub.docker.com/r/staphb/samtools
  * http://www.htslib.org/
